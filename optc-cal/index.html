<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Global OPTC Calendar</title>

    <link href="favicon.ico" rel="shortcut icon" />

    <link href="assets/css/fullcalendar.min.css" rel="stylesheet" />
    <link href="assets/css/bootstrap.min.css" rel="stylesheet" />
    <script src="assets/libs/jquery.min.js"></script>
    <script src="assets/libs/moment.min.js"></script>
    <script src="assets/libs/fullcalendar.min.js"></script>
    <script src="assets/libs/bootstrap.min.js"></script>

    <script src="app/data/fortnights.js"></script>
    <script src="app/data/raids.js"></script>
    <script src="app/data/coliseums.js"></script>
    <script src="app/data/ambushes.js"></script>
    <script src="app/data/specials.js"></script>
    <script src="app/data/specials_bg.js"></script>

    <script src="app/data/drops.js"></script>
    <script src="app/data/gw.js"></script>
    <script src="app/data/sevenDays.js"></script>

    <script src="app/calEvents/fortnightEvents.js"></script>
    <script src="app/calEvents/raidEvents.js"></script>
    <script src="app/calEvents/coliseumEvents.js"></script>
    <script src="app/calEvents/specialEvents.js"></script>
    <script src="app/calEvents/specialBgEvents.js"></script>

    <!-- Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-102555316-1', 'auto');
      ga('send', 'pageview');

    </script>

    <script>
        $(document).ready(function() {
            function createFortnightEvent(e) {
                var res = {};

                var id = e['id'];
                var fn = fortnights[id];

                res['id'] = id;

                var title = '『FN』';

                if (e['has_ranking'])
                    title += ' ★Rank';

                title += '\n' + fn['name'];

                res['title'] = title;

                res['thumb'] = fn['thumb'];
                res['type'] = 'fortnight';

                res['start'] = e['start'];
                res['end'] = e['end'];

                var opacity = e['is_replay'] ? 0.3 : 0.6;
                res['color'] = 'rgba(255, 0, 0, ' + opacity + ')';
                res['textColor'] = 'black';

                return res;
            }

            function createRaidEvent(e) {
                var res = {};

                var eId = e['id'];

                if (Array.isArray(eId)) {
                    res['id'] = eId.slice();
                    res['thumb'] = [];

                    for (i = 0; i < eId.length; i++) {
                        var eRd = raids[eId[i]];
                        res['thumb'].push(eRd['thumb']);
                    }
                } else {
                    var rd = raids[eId];
                    res['id'] = eId;

                    var title = '『RD』';

                    if (typeof e['ambush'] !== 'undefined') {
                        res['ambush'] = e['ambush'];
                        eventArray.push(createAmbushEvent(e['ambush'], e['start'], e['end'], 'raid'));
                    }

                    title += '\n' + rd['name'];

                    res['title'] = title;

                    res['thumb'] = rd['thumb'];
                }

                res['type'] = 'raid';

                res['start'] = e['start'];
                if (typeof e['end'] !== 'undefined')
                    res['end'] = e['end'];

                res['color'] = 'rgba(60, 179, 113, 0.6)';
                res['textColor'] = 'black';

                return res;
            }

            function createColiseumEvent(e) {
                var res = {};

                var newId = e['newId'];
                res['newThumb'] = [];
                for (i = 0; i < newId.length; i++) {
                    var newColi = coliseums[newId[i]];
                    res['newThumb'].push(newColi['thumb']);
                }

                var repId = e['repId'];
                res['repThumb'] = [];
                for (i = 0; i < repId.length; i++) {
                    var repColi = coliseums[repId[i]];
                    res['repThumb'].push(repColi['thumb']);
                }

                if (typeof e['ambush'] !== 'undefined') {
                    res['ambush'] = e['ambush'];
                    eventArray.push(createAmbushEvent(e['ambush'], e['start'], e['end'], 'coliseum'));
                }


                res['id'] = newId.concat(repId);

                res['type'] = 'coliseum';

                res['start'] = e['start'];
                if (typeof e['end'] !== 'undefined')
                    res['end'] = e['end'];

                res['color'] = 'rgba(0, 0, 255, 0.6)';

                return res;
            }

            function createAmbushEvent(id, start, end, src) {
                var res = {};

                var ambush = ambushes[id];

                res['id'] = id;
                res['title'] = ambush['name'];
                res['thumb'] = ambush['thumb'];
                res['start'] = start;
                if (typeof end !== 'undefined')
                    res['end'] = end;

                if ('raid' == src) {
                    res['type'] = 'raidAmbush';
                    res['color'] = 'rgba(60, 179, 113, 0.6)';
                } else {
                    res['type'] = 'coliAmbush';
                    res['color'] = 'rgba(0, 0, 255, 0.6)';
                }

                res['textColor'] = 'black';

                return res;
            }

            function createSpecialEvent(e) {
                var res = {};

                var id = e['id'];

                if ('dummy' == id) {
                    res['color'] = 'rgba(255, 255, 255, 0)';
                    res['textColor'] = 'rgba(255, 255, 255, 0)';
                } else {
                    var sp = specials[id];

                    var title = '『' + sp['type'] + '』';
                    title += '\n' + sp['name'];

                    res['title'] = title;

                    res['thumb'] = sp['thumb'];

                    res['color'] = 'rgba(75, 0, 130, 0.6)';
                    res['textColor'] = 'black';
                }

                res['id'] = id;

                res['type'] = 'special';

                res['start'] = e['start'];
                if (typeof e['end'] !== 'undefined')
                    res['end'] = e['end'];

                return res;
            }

            function createSpecialBgEvent(e) {
                var res = {};

                var id = e['id'];
                var sbge = specials_bg[id];

                res['thumb'] = sbge['thumb'];
                res['type'] = 'event';

                res['start'] = e['start'];
                res['end'] = e['end'];

                res['color'] = 'rgba(0, 0, 0, 0)';
                res['rendering'] = 'background';

                return res;
            }

            function getThumb(thumbId) {
                return 'https://onepiece-treasurecruise.com/wp-content/uploads/f' + thumbId + '.png';
            }

            function getEventDetail(e) {
                var ids = [];

                if (Array.isArray(e.id))
                    ids = e.id.slice();
                else
                    ids.push(e.id);

                if (typeof e.ambush !== 'undefined')
                    ids.push(e.ambush);

                for (i = 0; i < ids.length; i++) {
                    var ed = $('#eventDetailClone').clone();
                    var id = ids[i];
                    ed.attr('id', "eventDetail_" + id);

                    var data;
                    if (e.type == 'fortnight')
                        data = fortnights[id];
                    else if (e.type == 'raid')
                        data = raids[id];
                    else if (e.type == 'coliseum')
                        data = coliseums[id];

                    if (typeof e.ambush !== 'undefined' && typeof data === 'undefined')
                        data = ambushes[id];

                    var imgSrc = getThumb(data['thumb']);
                    ed.find('.eventThumb').html('<img src="' + imgSrc + '" height="30" width="30" />');

                    ed.find('.eventTitle').text(data['name']);

                    if (typeof drops[id] !== 'undefined') {
                        var dropList = ed.find('.dropList');
                        var dropUrl = 'http://optc-db.github.io/drops/?' + drops[id];

                        dropList.html('<a href="' + dropUrl + '" target="_blank">Drop List</a>');
                        dropList.show();
                    }

                    if (typeof gw[id] !== 'undefined') {
                        var gamewith = ed.find('.gamewith');
                        var gwUrl = 'https://トレクル.gamewith.jp/article/show/' + gw[id];

                        gamewith.html('<a href="' + gwUrl + '" target="_blank">Gamewith Guide</a>');
                        gamewith.show();
                    }

                    if (typeof sd[id] !== 'undefined') {
                        var sevenDays = ed.find('.sevenDays');
                        var sdUrl = 'https://www.reddit.com/r/OnePieceTC/comments/' + sd[id];

                        sevenDays.html('<a href="' + sdUrl + '" target="_blank">7 Days Guide</a>');
                        sevenDays.show();
                    }

                    $('#eventDetail').append(ed);
                    ed.show();
                }
            }

            var eventArray = [];

            fortnightEvents.forEach(function(e) {
                eventArray.push(createFortnightEvent(e));
            });

            raidEvents.forEach(function(e) {
                eventArray.push(createRaidEvent(e));
            });

            coliseumEvents.forEach(function(e) {
                eventArray.push(createColiseumEvent(e));
            });

            specialEvents.forEach(function(e) {
                eventArray.push(createSpecialEvent(e));
            });

            specialBgEvents.forEach(function(e) {
                eventArray.push(createSpecialBgEvent(e));
            });

            // Permanent Mihawk
            var mihawk = {
                'thumb': 'mihawk',
                'type': 'event',
                'color': 'rgba(0, 0, 0, 0)',
                'rendering': 'background',
                'permaStart': '2017-06-08',
                'dow': [5, 6]
            }
            eventArray.push(mihawk);

            $('#calendar').fullCalendar({
                aspectRatio: 0.55,
                events: eventArray,
                eventRender: function(event, element) {
                    if (event.type == 'fortnight' || event.type == 'raid' || (event.type == 'special' && event.id != 'dummy')) {
                        var thumbArray = [];
                        if (Array.isArray(event.thumb))
                            thumbArray = event.thumb.slice();
                        else
                            thumbArray.push(event.thumb);

                        for (i = 0; i < thumbArray.length; i++) {
                            var imgSrc = getThumb(thumbArray[i]);

                            element.find('.fc-title').before(
                                '<img src="' + imgSrc + '" height="30" width="30" style="float: left;" />'
                            );
                        }
                    } else if (event.type == 'raidAmbush' || event.type == 'coliAmbush') {
                        var imgSrc = getThumb(event.thumb);

                        element.find('.fc-title').before(
                            '<img src="' + imgSrc + '" height="15" width="15" style="float: left;" />'
                        );
                    } else if (event.type == 'coliseum') {
                        for (i = 0; i < event.newThumb.length; i++) {
                            var imgSrc = getThumb(event.newThumb[i]);

                            element.find('.fc-title').before(
                                '<img src="' + imgSrc + '" height="30" width="30" style="float: left;" />'
                            );
                        }

                        for (i = 0; i < event.repThumb.length; i++) {
                            var imgSrc = getThumb(event.repThumb[i]);

                            element.find('.fc-title').before(
                                '<img src="' + imgSrc + '" height="20" width="20" style="float: left;" />'
                            );
                        }
                    } else {
                        element.closest('.fc-bgevent').css('background-image', 'url("assets/img/' + event.thumb + '.png")');
                    }

                    if (typeof event.permaStart !== 'undefined')
                        return event.start.isAfter(event.permaStart);
                },
                eventClick: function(event) {
                    if (event.type == 'fortnight' || event.type == 'raid' || event.type == 'coliseum') {
                        $('#eventDetail').empty();
                        getEventDetail(event);
                        $('#eventDetailModal').modal();
                    }
                },
                eventOrder: function(a, b) {
                    var orderMap = {
                        'fortnight': 0,
                        'raid': 1,
                        'raidAmbush': 2,
                        'coliseum': 3,
                        'coliAmbush': 4,
                        'special': -1
                    }

                    return orderMap[a.type] > orderMap[b.type];
                },
                displayEventTime: false
            });
        });
    </script>

    <style>
        body {
            margin: 40px 10px;
            padding: 0;
            font-family: Arial, Helvetica, sans-serif;
            font-size: 15px;
        }

        #footer, #optc-agenda, #help {
            width: 100%;
            text-align: center;
        }

        #eventDetailModal {
            top: 30%;
        }

        #calendar {
            width: 1052.1px;  /* 150px per cell, with 2.1px of lines */
            margin: 0 auto;
        }

        .fc-title {
            padding-left: 10px;
            -webkit-box-decoration-break: clone;
            box-decoration-break: clone;
        }

        .fc-bgevent {
            opacity: 0.75;
        }
    </style>
</head>

<body>
    <div id="eventDetailModal" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Helpful Links</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div id="eventDetail" class="modal-body"></div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="eventDetailClone" style="display: none;">
        <div class="eventThumb" style="float: left;"></div>
        <div style="margin-left: 50px;">
            <h6 class="eventTitle"></h6>
            <ul>
                <li class="dropList" style="display: none;"></li>
                <li class="gamewith" style="display: none;"></li>
                <li class="sevenDays" style="display: none;"></li>
            </ul>
        </div>
    </div>

    <div id="optc-agenda">
        <a href="https://optc-agenda.github.io/" target="_blank">Week View Mode (to OPTC Agenda)</a>
    </div>

    <div id="help">
        * Click on Fortnights/Raids/Coliseums for links to drops and guides *
    </div>

    <div id="calendar"></div>

    <br />

    <div id="footer">
        Calendar by <a href="https://www.reddit.com/u/zl1814" target="_blank">u/zl1814</a>, background images provided by <a href="https://www.reddit.com/u/qblcookie" target="_blank">u/qblcookie</a>
        <br />
        Please report bugs and errors to <a href="https://www.reddit.com/u/zl1814" target="_blank">u/zl1814</a> thorugh Reddit
        <br />
        欢迎中文玩家加入OPTC美服QQ群: 450369501
        <br />
        This site does not own any of the images. All images are owned by Eiichiro Oda/Shueisha, Toei Animation, and Bandai Namco.
    </div>
</body>
</html>
